name: Robot Framework Test

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  Chrome:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Get Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Notify Slack - Start
        run: |
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "@canal üöÄ Pipeline de testes no Chrome iniciado por '${{ github.actor }}' come√ßou!"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run tests
        id: run-tests
        run: |
          robot -d tests/results -v BROWSER:chrome tests

      - name: Analyze Test Results
        id: analyze-results
        run: |
          # Conta os testes
          total_tests=$(grep -o 'total tests="[^"]*"' tests/results/output.xml | sed 's/.*="//;s/".*//')
          passed_tests=$(grep -o 'pass="[^"]*"' tests/results/output.xml | sed 's/.*="//;s/".*//')
          failed_tests=$(grep -o 'fail="[^"]*"' tests/results/output.xml | sed 's/.*="//;s/".*//')
          echo "total_tests=$total_tests" >> $GITHUB_ENV
          echo "passed_tests=$passed_tests" >> $GITHUB_ENV
          echo "failed_tests=$failed_tests" >> $GITHUB_ENV
          if [ "$failed_tests" -gt 0 ] && [ "$passed_tests" -gt 0 ]; then
            echo "test_result=partial_failure" >> $GITHUB_ENV
          elif [ "$failed_tests" -gt 0 ] && [ "$passed_tests" -eq 0 ]; then
            echo "test_result=complete_failure" >> $GITHUB_ENV
          else
            echo "test_result=success" >> $GITHUB_ENV
          fi

      - name: Robot Reporter
        uses: joonvena/robotframework-reporter-action@v2.4
        if: always()
        with:
          gh_access_token: ${{secrets.GITHUB_TOKEN}}
          report_path: tests/results

      - name: Upload Report
        uses: actions/upload-artifact@v4.3.3
        if: always()
        with:
          name: Chrome Report
          path: tests/results

      - name: Notify Slack - Success
        if: env.test_result == 'success'
        run: |
          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "@canal ‚úÖ Pipeline de testes no Chrome iniciado por '${{ github.actor }}' finalizado com sucesso! <'"$REPORT_URL"'|Veja o relat√≥rio>"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - Partial Failure
        if: env.test_result == 'partial_failure'
        run: |
          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "@canal ‚ö†Ô∏è Pipeline de testes no Chrome iniciado por '${{ github.actor }}' finalizado com algumas falhas! <'"$REPORT_URL"'|Veja o relat√≥rio>"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - Complete Failure
        if: env.test_result == 'complete_failure'
        run: |
          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "@canal ‚ùå Pipeline de testes no Chrome iniciado por '${{ github.actor }}' falhou completamente! <'"$REPORT_URL"'|Veja o relat√≥rio>"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

  Firefox:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Get Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Firefox
        uses: browser-actions/setup-firefox@v1.5.1
        with:
          firefox-version: latest-esr

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Notify Slack - Start
        run: |
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "@canal üöÄ Pipeline de testes no Firefox iniciado por '${{ github.actor }}' come√ßou!"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run tests
        id: run-tests
        run: |
          robot -d tests/results -v BROWSER:firefox tests

      - name: Analyze Test Results
        id: analyze-results
        run: |
          # Conta os testes
          total_tests=$(grep -o 'total tests="[^"]*"' tests/results/output.xml | sed 's/.*="//;s/".*//')
          passed_tests=$(grep -o 'pass="[^"]*"' tests/results/output.xml | sed 's/.*="//;s/".*//')
          failed_tests=$(grep -o 'fail="[^"]*"' tests/results/output.xml | sed 's/.*="//;s/".*//')
          echo "total_tests=$total_tests" >> $GITHUB_ENV
          echo "passed_tests=$passed_tests" >> $GITHUB_ENV
          echo "failed_tests=$failed_tests" >> $GITHUB_ENV
          if [ "$failed_tests" -gt 0 ] && [ "$passed_tests" -gt 0 ]; then
            echo "test_result=partial_failure" >> $GITHUB_ENV
          elif [ "$failed_tests" -gt 0 ] && [ "$passed_tests" -eq 0 ]; then
            echo "test_result=complete_failure" >> $GITHUB_ENV
          else
            echo "test_result=success" >> $GITHUB_ENV
          fi

      - name: Robot Reporter
        uses: joonvena/robotframework-reporter-action@v2.4
        if: always()
        with:
          gh_access_token: ${{secrets.GITHUB_TOKEN}}
          report_path: tests/results

      - name: Upload Report
        uses: actions/upload-artifact@v4.3.3
        if: always()
        with:
          name: Firefox Report
          path: tests/results

      - name: Notify Slack - Success
        if: env.test_result == 'success'
        run: |
          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "@canal ‚úÖ Pipeline de testes no Firefox iniciado por '${{ github.actor }}' finalizado com sucesso! <'"$REPORT_URL"'|Veja o relat√≥rio>"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - Partial Failure
        if: env.test_result == 'partial_failure'
        run: |
          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "@canal ‚ö†Ô∏è Pipeline de testes no Firefox iniciado por '${{ github.actor }}' finalizado com algumas falhas! <'"$REPORT_URL"'|Veja o relat√≥rio>"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - Complete Failure
        if: env.test_result == 'complete_failure'
        run: |
          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -X POST -H 'Content-Type: application/json' \
          -d '{"text": "@canal ‚ùå Pipeline de testes no Firefox iniciado por '${{ github.actor }}' falhou completamente! <'"$REPORT_URL"'|Veja o relat√≥rio>"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
